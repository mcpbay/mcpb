name: Build and Release MCPB

on:
  push:
    tags:
      - "v*"

permissions:
  contents: write

env:
  APP_NAME: mcpb

jobs:
  build:
    name: Build ${{ matrix.name }}
    runs-on: ${{ matrix.os }}

    strategy:
      matrix:
        include:
          - name: Windows
            os: windows-latest
            task: build:windows
            artifact: mcpb-windows.exe

          - name: Linux Intel
            os: ubuntu-latest
            task: build:linux-intel
            artifact: mcpb-linux-intel

          - name: Linux ARM
            os: ubuntu-latest
            task: build:linux-arm
            artifact: mcpb-linux-arm

          - name: Mac Intel
            os: macos-latest
            task: build:mac-intel
            artifact: mcpb-mac-intel

          - name: Mac ARM
            os: macos-latest
            task: build:mac-arm
            artifact: mcpb-mac-arm

    steps:
      - uses: actions/checkout@v4

      - uses: denoland/setup-deno@v2
        with:
          deno-version: v2.x

      - run: deno task ${{ matrix.task }}

      - uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.artifact }}
          path: dist/${{ matrix.artifact }}

  release:
    name: Create Release
    needs: build
    runs-on: ubuntu-latest

    steps:
      - uses: actions/download-artifact@v4

      # ------------------------
      # Generate SHA256 checksums
      # ------------------------
      - name: Generate SHA256
        run: |
          for dir in mcpb-*; do
            if [ -d "$dir" ]; then
              file=$(find "$dir" -type f)
              sha256sum "$file" >> checksums.txt
            fi
          done

      # ------------------------
      # Generate PowerShell Installer
      # ------------------------
      - name: Generate install.ps1
        run: |
          cat << 'EOF' > install.ps1
          $ErrorActionPreference = "Stop"

          Write-Host ""
          Write-Host "MCPB Installer"
          Write-Host "=============="
          Write-Host ""

          $repo = "${{ github.repository }}"
          $version = "${{ github.ref_name }}"
          $baseUrl = "https://github.com/$repo/releases/download/$version"

          $file = "mcpb-windows.exe"
          $checksumFile = "checksums.txt"

          $installDir = "$env:LOCALAPPDATA\Programs\mcpb"
          $output = "$installDir\mcpb.exe"

          New-Item -ItemType Directory -Force -Path $installDir | Out-Null

          $url = "$baseUrl/$file"
          $checksumUrl = "$baseUrl/$checksumFile"

          Write-Host "Downloading checksum file..."
          $checksums = Invoke-WebRequest -Uri $checksumUrl -UseBasicParsing
          $expectedHash = ($checksums.Content -split "`n" | Where-Object { $_ -match $file }).Split(" ")[0]

          Write-Host "Downloading binary..."

          $request = [System.Net.HttpWebRequest]::Create($url)
          $response = $request.GetResponse()

          $totalBytes = $response.ContentLength
          $stream = $response.GetResponseStream()
          $buffer = New-Object byte[] 8192
          $fileStream = [System.IO.File]::Create($output)

          $totalRead = 0
          $startTime = Get-Date

          try {
              while (($read = $stream.Read($buffer, 0, $buffer.Length)) -gt 0) {
                  $fileStream.Write($buffer, 0, $read)
                  $totalRead += $read

                  $elapsed = (Get-Date) - $startTime
                  $speed = if ($elapsed.TotalSeconds -gt 0) { ($totalRead / 1MB) / $elapsed.TotalSeconds } else { 0 }
                  $percent = [math]::Round(($totalRead / $totalBytes) * 100, 2)
                  $remainingBytes = $totalBytes - $totalRead
                  $eta = if ($speed -gt 0) { $remainingBytes / 1MB / $speed } else { 0 }

                  Write-Progress `
                      -Activity "Downloading MCPB..." `
                      -Status ("{0}% | {1:N2} MB of {2:N2} MB | {3:N2} MB/s | ETA {4:N1}s" -f `
                          $percent,
                          ($totalRead/1MB),
                          ($totalBytes/1MB),
                          $speed,
                          $eta) `
                      -PercentComplete $percent
              }
          }
          finally {
              $fileStream.Close()
              $stream.Close()
              $response.Close()
          }

          Write-Progress -Activity "Downloading MCPB..." -Completed

          Write-Host "Verifying checksum..."
          $actualHash = (Get-FileHash $output -Algorithm SHA256).Hash.ToLower()

          if ($actualHash -ne $expectedHash.ToLower()) {
              Remove-Item $output
              Write-Error "Checksum verification failed. Installation aborted."
              exit 1
          }

          $currentPath = [Environment]::GetEnvironmentVariable("PATH", "User")
          if ($currentPath -notlike "*$installDir*") {
              [Environment]::SetEnvironmentVariable("PATH", "$currentPath;$installDir", "User")
          }

          Write-Host ""
          Write-Host "Installation completed successfully."
          Write-Host "Restart your terminal and run: mcpb"
          Write-Host ""
          EOF

      # ------------------------
      # Generate Bash Installer
      # ------------------------
      - name: Generate install.sh
        run: |
          cat << 'EOF' > install.sh
          #!/usr/bin/env bash
          set -e

          echo ""
          echo "MCPB Installer"
          echo "=============="
          echo ""

          REPO="${{ github.repository }}"
          VERSION="${{ github.ref_name }}"
          BASE_URL="https://github.com/$REPO/releases/download/$VERSION"

          OS="$(uname -s)"
          ARCH="$(uname -m)"

          if [[ "$OS" == "Linux" ]]; then
            [[ "$ARCH" == "x86_64" ]] && FILE="mcpb-linux-intel" || FILE="mcpb-linux-arm"
          elif [[ "$OS" == "Darwin" ]]; then
            [[ "$ARCH" == "x86_64" ]] && FILE="mcpb-mac-intel" || FILE="mcpb-mac-arm"
          else
            echo "Unsupported OS"
            exit 1
          fi

          INSTALL_DIR="$HOME/.local/bin"
          mkdir -p "$INSTALL_DIR"

          echo "Downloading checksum file..."
          curl -sL "$BASE_URL/checksums.txt" -o /tmp/mcpb_checksums.txt
          EXPECTED_HASH=$(grep "$FILE" /tmp/mcpb_checksums.txt | awk '{print $1}')

          echo ""
          echo "Downloading $FILE"
          echo ""

          curl -L --progress-bar "$BASE_URL/$FILE" -o "$INSTALL_DIR/mcpb"

          echo ""
          echo "Verifying checksum..."

          ACTUAL_HASH=$(sha256sum "$INSTALL_DIR/mcpb" | awk '{print $1}')

          if [[ "$ACTUAL_HASH" != "$EXPECTED_HASH" ]]; then
            rm "$INSTALL_DIR/mcpb"
            echo "Checksum verification failed. Installation aborted."
            exit 1
          fi

          chmod +x "$INSTALL_DIR/mcpb"

          echo ""
          echo "Installation completed successfully."
          echo "Ensure $HOME/.local/bin is in your PATH."
          echo ""
          EOF

      - name: Make install.sh executable
        run: chmod +x install.sh

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          files: |
            mcpb-windows.exe/mcpb-windows.exe
            mcpb-linux-intel/mcpb-linux-intel
            mcpb-linux-arm/mcpb-linux-arm
            mcpb-mac-intel/mcpb-mac-intel
            mcpb-mac-arm/mcpb-mac-arm
            checksums.txt
            install.ps1
            install.sh
