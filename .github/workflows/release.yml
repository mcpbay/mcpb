name: Build and Release MCPB

on:
  push:
    tags:
      - "v*"

permissions:
  contents: write

env:
  APP_NAME: mcpb

jobs:
  build:
    name: Build ${{ matrix.name }}
    runs-on: ${{ matrix.os }}

    strategy:
      matrix:
        include:
          - name: Windows
            os: windows-latest
            task: build:windows
            artifact: mcpb-windows.exe

          - name: Linux Intel
            os: ubuntu-latest
            task: build:linux-intel
            artifact: mcpb-linux-intel

          - name: Linux ARM
            os: ubuntu-latest
            task: build:linux-arm
            artifact: mcpb-linux-arm

          - name: Mac Intel
            os: macos-latest
            task: build:mac-intel
            artifact: mcpb-mac-intel

          - name: Mac ARM
            os: macos-latest
            task: build:mac-arm
            artifact: mcpb-mac-arm

    steps:
      - uses: actions/checkout@v4
      - uses: denoland/setup-deno@v2
        with:
          deno-version: v2.x
      - run: deno task ${{ matrix.task }}
      - uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.artifact }}
          path: dist/${{ matrix.artifact }}

  release:
    name: Create Release
    needs: build
    runs-on: ubuntu-latest

    steps:
      - uses: actions/download-artifact@v4

      - name: Generate SHA256
        run: |
          > checksums.txt
          for dir in mcpb-*; do
            if [ -d "$dir" ]; then
              file=$(find "$dir" -type f)
              filename=$(basename "$file")
              hash=$(sha256sum "$file" | awk '{print $1}')
              echo "$hash  $filename" >> checksums.txt
            fi
          done

      # ------------------------
      # PowerShell Installer
      # ------------------------
      - name: Generate install.ps1
        run: |
          cat << 'EOF' > install.ps1
          param(
              [switch]$Silent,
              [switch]$Latest
          )

          $ErrorActionPreference = "Stop"

          $repo = "${{ github.repository }}"
          $version = "${{ github.ref_name }}"

          if ($Latest) {
              $release = Invoke-RestMethod "https://api.github.com/repos/$repo/releases/latest"
              $version = $release.tag_name
          }

          $baseUrl = "https://github.com/$repo/releases/download/$version"
          $file = "mcpb-windows.exe"
          $checksumFile = "checksums.txt"

          $installDir = "$env:LOCALAPPDATA\Programs\mcpb"
          $output = "$installDir\mcpb.exe"

          New-Item -ItemType Directory -Force -Path $installDir | Out-Null

          # Detect running process
          $running = Get-Process -Name "mcpb" -ErrorAction SilentlyContinue
          if ($running) {
              Write-Error "MCPB is currently running. Close it before updating."
              exit 1
          }

          $checksumUrl = "$baseUrl/$checksumFile"
          $checksums = Invoke-WebRequest -Uri $checksumUrl -UseBasicParsing

          # Normalizar saltos de línea y espacios
          $lines = $checksums.Content -split "(`r)?`n" | ForEach-Object { $_.Trim() }
          $line = $lines | Where-Object { $_ -match [regex]::Escape($file) }

          if (-not $line) {
              Write-Error "Checksum entry not found."
              exit 1
          }

          $expectedHash = ($line -split "\s+")[0]
          $url = "$baseUrl/$file"

          if (-not $Silent) { Write-Host "Downloading $version..." }

          Invoke-WebRequest -Uri $url -OutFile $output

          $actualHash = (Get-FileHash $output -Algorithm SHA256).Hash.ToLower()

          if ($actualHash -ne $expectedHash.ToLower()) {
              Remove-Item $output
              Write-Error "Checksum verification failed."
              exit 1
          }

          # Agregar al PATH si no está
          $currentPath = [Environment]::GetEnvironmentVariable("PATH", "User")
          if ($currentPath -notlike "*$installDir*") {
              [Environment]::SetEnvironmentVariable("PATH", "$currentPath;$installDir", "User")
          }

          if (-not $Silent) {
              Write-Host "Installation completed."
          }
          EOF

      # ------------------------
      # Bash Installer
      # ------------------------
      - name: Generate install.sh
        run: |
          cat << 'EOF' > install.sh
          #!/usr/bin/env bash
          set -e

          SILENT=false
          LATEST=false

          for arg in "$@"; do
            case $arg in
              --silent) SILENT=true ;;
              --latest) LATEST=true ;;
            esac
          done

          REPO="${{ github.repository }}"
          VERSION="${{ github.ref_name }}"

          if [ "$LATEST" = true ]; then
            VERSION=$(curl -s https://api.github.com/repos/$REPO/releases/latest | grep tag_name | cut -d '"' -f4)
          fi

          BASE_URL="https://github.com/$REPO/releases/download/$VERSION"

          OS="$(uname -s)"
          ARCH="$(uname -m)"

          if [[ "$OS" == "Linux" ]]; then
            [[ "$ARCH" == "x86_64" ]] && FILE="mcpb-linux-intel" || FILE="mcpb-linux-arm"
          elif [[ "$OS" == "Darwin" ]]; then
            [[ "$ARCH" == "x86_64" ]] && FILE="mcpb-mac-intel" || FILE="mcpb-mac-arm"
          else
            echo "Unsupported OS"
            exit 1
          fi

          if [ "$EUID" -eq 0 ]; then
            INSTALL_DIR="/usr/local/bin"
          else
            INSTALL_DIR="$HOME/.local/bin"
          fi

          TARGET="$INSTALL_DIR/mcpb"

          # Detect running binary
          if command -v lsof >/dev/null 2>&1; then
            if lsof "$TARGET" >/dev/null 2>&1; then
              echo "MCPB is currently running. Close it before updating."
              exit 1
            fi
          fi

          mkdir -p "$INSTALL_DIR"

          curl -sL "$BASE_URL/checksums.txt" -o /tmp/mcpb_checksums.txt
          EXPECTED_HASH=$(grep "$FILE" /tmp/mcpb_checksums.txt | awk '{print $1}')

          [ "$SILENT" = false ] && echo "Downloading $VERSION..."

          curl -sL "$BASE_URL/$FILE" -o "$TARGET"

          ACTUAL_HASH=$(sha256sum "$TARGET" | awk '{print $1}')

          if [[ "$ACTUAL_HASH" != "$EXPECTED_HASH" ]]; then
            rm "$TARGET"
            echo "Checksum verification failed."
            exit 1
          fi

          chmod +x "$TARGET"

          [ "$SILENT" = false ] && echo "Installation completed."
          EOF

      - name: Make install.sh executable
        run: chmod +x install.sh

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          files: |
            mcpb-windows.exe/mcpb-windows.exe
            mcpb-linux-intel/mcpb-linux-intel
            mcpb-linux-arm/mcpb-linux-arm
            mcpb-mac-intel/mcpb-mac-intel
            mcpb-mac-arm/mcpb-mac-arm
            checksums.txt
            install.ps1
            install.sh
