name: Build and Release MCPB

on:
  push:
    tags:
      - "v*"

permissions:
  contents: write

env:
  APP_NAME: mcpb

jobs:
  build:
    name: Build ${{ matrix.name }}
    runs-on: ${{ matrix.os }}

    strategy:
      matrix:
        include:
          - name: Windows
            os: windows-latest
            task: build:windows
            artifact: mcpb-windows.exe

          - name: Linux Intel
            os: ubuntu-latest
            task: build:linux-intel
            artifact: mcpb-linux-intel

          - name: Linux ARM
            os: ubuntu-latest
            task: build:linux-arm
            artifact: mcpb-linux-arm

          - name: Mac Intel
            os: macos-latest
            task: build:mac-intel
            artifact: mcpb-mac-intel

          - name: Mac ARM
            os: macos-latest
            task: build:mac-arm
            artifact: mcpb-mac-arm

    steps:
      - uses: actions/checkout@v4
      - uses: denoland/setup-deno@v2
        with:
          deno-version: v2.x
      - run: deno task ${{ matrix.task }}
      - uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.artifact }}
          path: dist/${{ matrix.artifact }}

  release:
    name: Create Release
    needs: build
    runs-on: ubuntu-latest

    steps:
      - uses: actions/download-artifact@v4

      - name: Generate SHA256
        run: |
          > checksums.json
          echo "{" > checksums.json
          first=true
          for dir in mcpb-*; do
            if [ -d "$dir" ]; then
              file=$(find "$dir" -type f)
              filename=$(basename "$file")
              hash=$(sha256sum "$file" | awk '{print $1}')
              if [ "$first" = true ]; then
                first=false
              else
                echo "," >> checksums.json
              fi
              echo "  \"${filename}\": \"${hash}\"" >> checksums.json
            fi
          done
          echo "}" >> checksums.json

      # ------------------------
      # PowerShell Installer
      # ------------------------
      - name: Generate install.ps1
        run: |
          cat << 'EOF' > install.ps1
          param(
              [switch]$Silent,
              [switch]$Latest,
              [switch]$Debug,
              [switch]$Force
          )

          $ErrorActionPreference = "Stop"

          function Write-DebugLog {
              param([string]$Message)
              if ($Debug) { Write-Host "[DEBUG] $Message" }
          }

          function Format-FileSize {
              param([long]$Bytes)
              if ($Bytes -ge 1GB) {
                  return "{0:N2} GB" -f ($Bytes / 1GB)
              } elseif ($Bytes -ge 1MB) {
                  return "{0:N2} MB" -f ($Bytes / 1MB)
              } elseif ($Bytes -ge 1KB) {
                  return "{0:N2} KB" -f ($Bytes / 1KB)
              } else {
                  return "$Bytes bytes"
              }
          }

          function Download-FileWithProgress {
              param(
                  [string]$Url,
                  [string]$OutputPath
              )

              try {
                  $uri = New-Object System.Uri($Url)
                  $request = [System.Net.HttpWebRequest]::Create($uri)
                  $request.set_Timeout(15000)
                  $request.AllowAutoRedirect = $true
                  $request.MaximumAutomaticRedirections = 5

                  $response = $request.GetResponse()
                  $totalLength = [long]$response.get_ContentLength()
                  $responseStream = $response.GetResponseStream()

                  $targetStream = New-Object System.IO.FileStream($OutputPath, [System.IO.FileMode]::Create)

                  $buffer = New-Object byte[] 65536
                  $count = $responseStream.Read($buffer, 0, $buffer.length)
                  $downloadedBytes = $count
                  $startTime = Get-Date

                  Write-Host ""
                  Write-Host "Total size: $(Format-FileSize $totalLength)"
                  Write-Host "Press CTRL+C to cancel"
                  Write-Host ""

                  while ($count -gt 0) {
                      $targetStream.Write($buffer, 0, $count)
                      $count = $responseStream.Read($buffer, 0, $buffer.length)
                      $downloadedBytes = $downloadedBytes + $count

                      $percentComplete = [int](($downloadedBytes / $totalLength) * 100)
                      $downloaded = Format-FileSize $downloadedBytes
                      $total = Format-FileSize $totalLength

                      # Calculate speed
                      $elapsed = ((Get-Date) - $startTime).TotalSeconds
                      if ($elapsed -gt 0) {
                          $speed = $downloadedBytes / $elapsed
                          $speedStr = Format-FileSize $speed
                      } else {
                          $speedStr = "0 bytes"
                      }

                      # Progress bar
                      $barLength = 40
                      $completed = [int](($percentComplete / 100) * $barLength)
                      $remaining = $barLength - $completed
                      if ($remaining -gt 0) {
                          $bar = "[" + ("=" * $completed) + ">" + (" " * ($remaining - 1)) + "]"
                      } else {
                          $bar = "[" + ("=" * $barLength) + "]"
                      }

                      # Show progress
                      $status = "$bar $percentComplete% | $downloaded / $total | $speedStr/s"
                      Write-Host "`r$status" -NoNewline
                  }

                  Write-Host ""
                  Write-Host ""
                  Write-Host "Download completed successfully."

                  $targetStream.Flush()
                  $targetStream.Close()
                  $targetStream.Dispose()
                  $responseStream.Dispose()
                  $response.Close()

              } catch {
                  Write-Error "Download error: $_"
                  if (Test-Path $OutputPath) {
                      Remove-Item $OutputPath -Force
                  }
                  exit 1
              }
          }

          $repo = "${{ github.repository }}"
          $version = "${{ github.ref_name }}"

          Write-DebugLog "Repo: $repo, Version: $version"

          if ($Latest) {
              Write-DebugLog "Fetching latest release info..."
              $release = Invoke-RestMethod "https://api.github.com/repos/$repo/releases/latest"
              $version = $release.tag_name
              Write-DebugLog "Latest version: $version"
          }

          $baseUrl = "https://github.com/$repo/releases/download/$version"
          $file = "mcpb-windows.exe"
          $checksumFile = "checksums.json"

          $installDir = "$env:LOCALAPPDATA\Programs\mcpb"
          $output = "$installDir\mcpb.exe"

          Write-DebugLog "Install dir: $installDir, Output: $output"

          New-Item -ItemType Directory -Force -Path $installDir | Out-Null

          # Check if already installed
          if ((Test-Path $output) -and -not $Force) {
              try {
                  $installedVersion = & $output --version 2>$null
                  Write-DebugLog "Installed version output: $installedVersion"

                  # Extract version number (handle different formats)
                  if ($installedVersion -match '(\d+\.\d+\.\d+)') {
                      $installedVersion = $matches[1]
                  }

                  # Clean version strings for comparison
                  $targetVersion = $version -replace '^v', ''
                  $installedVersion = $installedVersion -replace '^v', ''

                  Write-DebugLog "Target version: $targetVersion"
                  Write-DebugLog "Installed version: $installedVersion"

                  if ($installedVersion -eq $targetVersion) {
                      Write-Host "MCPB $version is already installed."
                      Write-Host "Use -Force to reinstall."
                      exit 0
                  } else {
                      Write-Host "Upgrading from version $installedVersion to $version..."
                  }
              } catch {
                  Write-DebugLog "Could not determine installed version: $_"
                  Write-Host "Existing installation found. Proceeding with installation..."
              }
          }

          # Detect running process
          $running = Get-Process -Name "mcpb" -ErrorAction SilentlyContinue
          if ($running) {
              Write-Error "MCPB is currently running. Close it before updating."
              exit 1
          }

          $checksumUrl = "$baseUrl/$checksumFile"
          Write-DebugLog "Downloading checksums from $checksumUrl"
          $checksumsContent = Invoke-WebRequest -Uri $checksumUrl -UseBasicParsing
          $checksumsJson = $checksumsContent | ConvertFrom-Json

          if (-not $checksumsJson.PSObject.Properties.Name.Contains($file)) {
              Write-Error "Checksum entry for $file not found."
              exit 1
          }

          $expectedHash = $checksumsJson.$file
          $url = "$baseUrl/$file"

          Write-DebugLog "Expected hash: $expectedHash"

          if (-not $Silent -or $Debug) {
              Write-Host "Downloading $version from $url..."
          }

          # Download with progress
          Download-FileWithProgress -Url $url -OutputPath $output

          # Verify file exists
          if (-not (Test-Path $output)) {
              Write-Host "Download did not complete."
              exit 0
          }

          Write-Host "Verifying file integrity..."
          $actualHash = (Get-FileHash $output -Algorithm SHA256).Hash.ToLower()
          Write-DebugLog "Expected hash: $expectedHash"
          Write-DebugLog "Actual hash:   $actualHash"

          if ($actualHash -ne $expectedHash.ToLower()) {
              Remove-Item $output
              Write-Error "Checksum verification failed."
              exit 1
          }

          Write-Host "Verification successful."

          # Add to PATH if not present
          $currentPath = [Environment]::GetEnvironmentVariable("PATH", "User")
          if ($currentPath -notlike "*$installDir*") {
              [Environment]::SetEnvironmentVariable("PATH", "$currentPath;$installDir", "User")
              Write-DebugLog "Added $installDir to PATH"
          }

          if (-not $Silent -or $Debug) {
              Write-Host "Installation completed."
          }
          EOF

      # ------------------------
      # Bash Installer
      # ------------------------
      - name: Generate install.sh
        run: |
          cat << 'EOF' > install.sh
          #!/usr/bin/env bash
          set -e

          SILENT=false
          LATEST=false
          DEBUG=false
          FORCE=false

          for arg in "$@"; do
            case $arg in
              --silent) SILENT=true ;;
              --latest) LATEST=true ;;
              --debug) DEBUG=true ;;
              --force) FORCE=true ;;
            esac
          done

          function debug_log {
            if [ "$DEBUG" = true ]; then
              echo "[DEBUG] $1"
            fi
          }

          REPO="${{ github.repository }}"
          VERSION="${{ github.ref_name }}"

          debug_log "Repo: $REPO, Version: $VERSION"

          if [ "$LATEST" = true ]; then
            debug_log "Fetching latest release info..."
            VERSION=$(curl -s https://api.github.com/repos/$REPO/releases/latest | grep tag_name | cut -d '"' -f4)
            debug_log "Latest version: $VERSION"
          fi

          BASE_URL="https://github.com/$REPO/releases/download/$VERSION"

          OS="$(uname -s)"
          ARCH="$(uname -m)"
          debug_log "OS: $OS, ARCH: $ARCH"

          if [[ "$OS" == "Linux" ]]; then
            [[ "$ARCH" == "x86_64" ]] && FILE="mcpb-linux-intel" || FILE="mcpb-linux-arm"
          elif [[ "$OS" == "Darwin" ]]; then
            [[ "$ARCH" == "x86_64" ]] && FILE="mcpb-mac-intel" || FILE="mcpb-mac-arm"
          else
            echo "Unsupported OS"
            exit 1
          fi

          if [ "$EUID" -eq 0 ]; then
            INSTALL_DIR="/usr/local/bin"
          else
            INSTALL_DIR="$HOME/.local/bin"
          fi

          TARGET="$INSTALL_DIR/mcpb"

          # Check if already installed
          if [ -f "$TARGET" ] && [ "$FORCE" = false ]; then
            INSTALLED_VERSION=$($TARGET --version 2>/dev/null || echo "unknown")
            debug_log "Installed version output: $INSTALLED_VERSION"

            # Extract version number
            INSTALLED_VERSION=$(echo "$INSTALLED_VERSION" | grep -oP '\d+\.\d+\.\d+' || echo "unknown")
            TARGET_VERSION=$(echo "$VERSION" | sed 's/^v//')

            debug_log "Target version: $TARGET_VERSION"
            debug_log "Installed version: $INSTALLED_VERSION"

            if [ "$INSTALLED_VERSION" = "$TARGET_VERSION" ]; then
              echo "MCPB $VERSION is already installed."
              echo "Use --force to reinstall."
              exit 0
            else
              echo "Upgrading from version $INSTALLED_VERSION to $VERSION..."
            fi
          fi

          # Detect running binary
          if command -v lsof >/dev/null 2>&1; then
            if lsof "$TARGET" >/dev/null 2>&1; then
              echo "MCPB is currently running. Close it before updating."
              exit 1
            fi
          fi

          mkdir -p "$INSTALL_DIR"

          debug_log "Downloading checksums..."
          curl -sL "$BASE_URL/checksums.json" -o /tmp/mcpb_checksums.json
          EXPECTED_HASH=$(jq -r --arg file "$FILE" '.[$file]' /tmp/mcpb_checksums.json)

          if [ -z "$EXPECTED_HASH" ]; then
            echo "Checksum entry for $FILE not found."
            exit 1
          fi

          [ "$SILENT" = false ] && echo "Downloading $VERSION..."
          debug_log "File: $FILE"
          debug_log "Expected hash: $EXPECTED_HASH"

          curl -sL "$BASE_URL/$FILE" -o "$TARGET"

          ACTUAL_HASH=$(sha256sum "$TARGET" | awk '{print $1}')
          debug_log "Actual hash:   $ACTUAL_HASH"

          if [[ "$ACTUAL_HASH" != "$EXPECTED_HASH" ]]; then
            rm "$TARGET"
            echo "Checksum verification failed."
            exit 1
          fi

          chmod +x "$TARGET"

          [ "$SILENT" = false ] && echo "Installation completed."
          debug_log "Installation path: $TARGET"
          EOF

      - name: Make install.sh executable
        run: chmod +x install.sh

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          files: |
            mcpb-windows.exe/mcpb-windows.exe
            mcpb-linux-intel/mcpb-linux-intel
            mcpb-linux-arm/mcpb-linux-arm
            mcpb-mac-intel/mcpb-mac-intel
            mcpb-mac-arm/mcpb-mac-arm
            checksums.json
            install.ps1
            install.sh
